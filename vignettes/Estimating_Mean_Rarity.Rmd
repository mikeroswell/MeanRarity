---
title: "Estimating_Mean_Rarity"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Estimating_Mean_Rarity}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  
---


The MeanRarity package contains functions to compute and estimate Hill numbers, using the framework that Hill numbers simply compute the abundance-weighted [generalized] mean species rarity of a community. Additionally, the package contains some convenience functions for sampling abundance vectors and generating plots. This vignette is not a comprehensive guide to the package. However, it includes all the data and code to replicate the figures presented in Roswell et al. 2020 "A conceptual guide to measuring species diversity" Oikos doi. 

Thus, the examples in the vignette are ordered according to the figures in the article. 

The goal of [Hill] diversity metrics is to summarize the distribution of species' [relative] abundances. The first figure in the "Conceptual guide" is a visualization of the observed bee abundances from the four communities in the example dataset  `"beeObs"` analyzed in the guide. The package includes a simple representation of those data, `beeAbunds`. The function `radplot()` takes those data and returns a rank-abundance distribution plot. We love the new R package `patchwork` for assembling plots, and call that package here.  

```{r setup, include = F}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")#, dev = "pdf")
library(MeanRarity)
library(patchwork) 
library(dplyr)
library(ggplot2)
library(tidyr)
library(purrr)
library(SpadeR)
library(tictoc)
library(furrr)
```

```{r RAD plot, fig.height = 5, fig.width = 5, fig.retina = 2}

# to make RAD plot for communities comparable, use one maxab and one maxrich for all plots
maxab <- max(sapply(beeAbunds[2:5], max)) # the maximum observed species abundance in any community

maxrich <- max(sapply(beeAbunds[2:5], function(x){sum(x > 0)})) # maximum observed richness


myplots<-purrr::map(2:5, function(makedatind){
    radplot(beeAbunds[,makedatind], maxab = maxab, maxrich = maxrich
            , shape = 13 + makedatind # solid filled shapes
            , fill = c("#1b9e77", "#d95f02", "#7570b3", "#e7298a")[makedatind-1])
})


myplots[[1]] + # first community
  ggplot2::labs(x = "", title = ggplot2::element_blank()) + # syling
white_y(myplots[[3]]) + # second community 
  ggplot2::labs(x = "", title = ggplot2::element_blank()) + # styling
myplots[[2]] +  # third community
  ggplot2::labs(title = ggplot2::element_blank()) + # styling
white_y(myplots[[4]]) + # fourth community
  ggplot2::labs(title = ggplot2::element_blank()) # styling

```

The next figure in the guide shows that the expected value for both observed and estimated asymptotic richness increase with sample size. The code to generate expected diversity estimates is computationally expensive and it is recommended not to run the code in this vignette. It is however included in the package in the file "data-raw/DATASET.R", and the result is an exported dataset "mean_ests." 

```{r Compute mean diveristy estimates under rarefaction, eval = F}

# this takes a long time to run so we're going to stash it but export the data it creates

sz<-1:745 #sample sizes from 1 to maximum observed total abundance at a site
nrep<-200 #Large enough because estimating means

tictoc::tic() #time this
nc <- parallel::detectCores() - 1 #nc is number of cores to use in parallel processing
future::plan(strategy = future::multiprocess, workers = nc) #this sets up the cluster


div_ests <- purrr::map_dfr(1:nrep, function(k){
 furrr::future_map_dfr(sz, function(x){
    map(2:length(beeAbunds), function(sitio){
      f<-beeAbunds %>% dplyr::select(all_of(sitio))
      if(sum(f) > x){
        comm <- dplyr::pull(f) %>% subsam(size = x)

        obsrich = dfun(comm, 1)
        obsshan = dfun(comm, 0)
        obssimp = dfun(comm, -1)
        chaorich = SpadeR:::Chao_Hill_abu(comm, q = 0)
        chaoshan = SpadeR:::Chao_Hill_abu(comm, q = 1)
        chaosimp = SpadeR:::Chao_Hill_abu(comm, q = 2)

        return(data.frame(individuals = x
                     , obsrich
                     , chaorich
                     , obsshan
                     , chaoshan
                     , obssimp
                     , chaosimp
                     , site = names(f)))
      }
    })
  })
})

tictoc::toc() #507 seconds, not bad.
mean_narm <- function(x){mean(x, na.rm = T)}
mean_ests <- div_ests %>%
  dplyr::group_by(site, individuals) %>%
  dplyr::summarize_all(mean_narm)
```


``` {r Species Accumulation Curves, fig.width = 5, fig.height = 5}

site_ab <- purrr::map_dfr(names(beeAbunds[,2:5]), function(site){
  data.frame(site, abun = sum(beeAbunds[,site]))
})

mean_ests %>%
  left_join(site_ab) %>% mutate(cutrows = individuals > 0.8 * abun) %>%#this is because when bootstrapping can get funny things where the Chao1 levels off near observed abundance, didn't want to discuss this in guide since it's obvious but not interesting and possibly very confusing.
  filter(!cutrows) %>% 
  ggplot(aes(individuals, obsrich, color = site))+
  geom_point(alpha = 0.3, size = 0.5) +
  geom_point(aes(y = chaorich, color = site, shape = site)
             , size=0.8, alpha=0.5) +
  theme_classic() +
  labs(x = "\nIndividuals", y = "Species richness\n") +
  xlim(c(0, 400)) +
  ylim(c(0, 80)) +
  theme(text = element_text(size=14)
        , axis.text = element_text(colour = "black")) +
  theme(legend.position = "none") +
  scale_shape_manual(values = c(15:18)) +
  scale_color_brewer(palette = "Dark2")


```

Figure 3 in the guide shows an empirical Hill diversity profile. The `MeanRarity` package has a canned function to produce such profiles, `divpro`. This lightweight function does not produce asymptotic estimates. Because the guide focused on the mean rarity formulation for Hill diversities, parameterizing the scaling exponent with $\ell$, the profile is plotted from $\ell = -1$ to $\ell =1$, whereas other software packages such as `iNEXT` and `SpadeR` plot the profile from $q = 1-\ell =0$ to $q = 1-\ell =2$. 

```{r Diversity profile plot, fig.width = 5, fig.height = 5}
site_pro <- map_dfr(names(beeAbunds[2:5]), function(x){
  data.frame(site = x, divpro(beeAbunds[, x]))})

site_pro %>%  ggplot(aes(ell, d, color = site)) +
    geom_line() +
    geom_point(data=site_pro %>% filter(ell %in% c(-1,1,0))
               , aes(ell, d, color = site, shape = site)
               , size = 3, alpha = 0.5) +
    theme_classic() +
    theme(text = element_text(size = 14)
          , axis.text = element_text(colour = "black")
          , legend.position = "none") +
    #this is the unicode for the curly l
    labs(x = "Exponent \U2113", y = "Diversity") +
    scale_shape_manual(values = c(15:18)) +
    scale_color_brewer(palette = "Dark2")
```




```{r Balance plot, fig.width = 9, fig.height = 3}

# plot some rarity "balance plots" for guide to measuring diversity (Roswell et al. 2020 Oikos....)
ab <- c(20,8,5,4,2,1)

rich_bal <- rarity_plot(ab, 1, base_size = 12)+
  ggplot2::labs(x = "")+
  scale_color_brewer(type = "qual", palette = "Dark2") 

shan_bal <- white_y(rarity_plot(ab, 0, base_size = 12, verbose = F)) + #do not return all the text this time
  scale_color_brewer(type = "qual", palette = "Dark2")

simp_bal <- white_y(rarity_plot(ab, -1, base_size = 12, verbose = F)) + 
  ggplot2::labs(x = "")+
  scale_color_brewer(type = "qual", palette = "Dark2")

#assemble triptych with patchwork
rich_bal+shan_bal+simp_bal



```











