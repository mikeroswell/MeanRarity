---
title: "Using MeanRarity"
output: 
  rmarkdown::pdf_document: 
    fig_width: 3
    fig_height: 3
    latex_engine: xelatex
  rmarkdown::html_vignette: 
    fig_width: 3
    fig_height: 3
  rmarkdown::html_document:
    fig_width: 3
    fig_height: 3
    fig.retina: NULL
  word_document: default
bibliography: '`r system.file( "REFERENCES.bib", package="MeanRarity")`'
vignette: >
  %\VignetteIndexEntry{Using MeanRarity}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---


<!-- need to explore output formats for size, speed, and features (e.g. eqn numbers) -->
<!-- had been rmarkdown::html_vignette -->
<!-- also see html_document -->
<!-- also see prettydoc::html_pretty which might solve the equation numbering issues -->
<!-- https://bookdown.org/yihui/rmarkdown/prettydoc.html -->

<!-- Application: Short (no more than 3000-4000 words total) descriptions of new software that are intended to describe and promote the software as well as act as a citeable resource for developers. Application papers are made free to access for one month after being assigned to an issue in order to encourage uptake of the methodologies they describe. Uploading a package to a site such as CRAN or sourceforge in advance is not considered prior publication and will not hinder your submission to MEE. View some example Applications here: https://besjournals.onlinelibrary.wiley.com/hub/journal/2041210X/features/applicationpapers -->
<!-- also see https://www.jstatsoft.org/authors -->


\renewcommand{\[}{\begin{equation}}
\renewcommand{\]}{\end{equation}}

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE
  , comment = "#>"
 # , dev = "ragg_png"
)
```
```{r setup, include =F}
library(MeanRarity)
```
# ABSTRACT

1. Detecting, describing, and predicting biodiversity shifts, a critical project
in ecology and evolution, requires metrics with well-understood numerical and
statistical properties, and transparent interpretations. Recently, Hill
diversity measures have been promoted for their ability to accommodate many
historical biodiversity concepts, and quantify diversity in natural "effective
numbers" units. The switch to the "effective numbers" scale, while potentially
easing comparability and interpretability of disparate measures, can fuel false
beliefs about the numerical and statistical properties of Hill diversity
measures. Re-parameterizing the Hill number equation in terms of the generalized
mean rarity opens avenues to investigate the numerical and statistical
properties of these widely-used measures.

1. Here, we present the `R` package `MeanRarity`, which enables estimating and
visualizing Hill diversity (aka "Hill numbers") in terms of the average species
rarity, i.e the reciprocal of relative abundance. Ecologists, accustomed to
thinking about rarity in the context of diversity, may find it intuitive and
useful to interpret Hill diversities as the average species rarity on different
scales. With `MeanRarity`, users can compute mean rarity, generate plots to
visualize species abundance distributions and their average rarity, and simulate
species abundance distributions with known diversity. Here, we simulate species
abundance distributions, and estimate the diversity of these assemblages based
on random samples from these distributions. We investigate how the bias and
variability of Hill diversity estimates (i.e., the diversity of the sample, and
the estimated true diversity of the whole species abundance distribution) depend
on the scaling parameter in the Hill equation, features of the species abundance
distribution such as evenness, and sampling intensity.

1. Our simulations reveal that Hill-Simpson diversity estimates can be highly
variable. Within the range of sample sizes we investigated, sample Hill
diversity was always most variable for Hill Simpson diversity (scaling parameter
value equal to -1). While the asymptotic estimator for Hill-Simpson diversity
was relatively more stable, it was still more variable than asymptotic
Hill-diversity estimates between Hill-Simpson and Hill-Shannon (scaling
parameter values between -1 and 0). Furthermore, the asymptotic estimator for
Hill-Simpson diversity exhibited greater bias at low sample sizes than the
asymptotic estimator for Hill diversities with intermediate scaling parameter
values (including Hill-Shannon diversity), although, as previously reported, the
bias is negligible for the asymptotic estimates for all Hill diversities with a
scaling parameter less than about 0.75. once samples sizes were relatively
large, for all species abundance distributions tested.

1. `MeanRarity` provides tools to students, researchers, and biostatisticians to
understand and investigate Hill diversity metrics. Fixing diversity values, *a
priori*, in simulated species abundance distributions enables replicable,
targeted testing of numerical and statistical properties of Hill diversities and
their estimators. With this simulation platform, we tested Hill diversity
estimates on samples from species abundance distributions that differed in
shape, but not in richness. Our simulations reveal that for both sample Hill
diversities and asymptotic Hill diversity estimates, lower bias and variability
may be possible for Hill diversities between Hill-Simpson diversity and richness
(for scaling parameter values between -1 and 1) for small, incomplete samples.

# INTRODUCTION

Biodiversity underpins human existence and drives the character and function of
earthâ€™s ecosystems. At the same time, biodiversity is shifting and arguably,
declining, at an unprecedented rate due to anthropogenic global change. Yet,
detecting and describing this change means choosing just what to measure, and
how. Ecologists are faced with a dazzling array of choices.

Here, we introduce the R package `MeanRarity`, which enables estimating and
visualizing Hill diversity (aka "Hill numbers") in terms of the average species
"rarity." Rarity is defined as the reciprocal of relative abundance.

The average species rarity may be simpler to interpret than a transformed,
generalized entropy (i.e., how Hill numbers are typically derived). The rarity
parameterization clarifies the role of the scaling exponent, and this R package
provides illustration tools to visualize that scaling concretely. Furthermore,
this framework may provide an entry point for developing and testing diversity
estimators and their related interval estimates (e.g., confidence intervals);
this package contains tools to simulate species abundance distributions that
should streamline that process.

This R package provides functions for three purposes: (1) computing Hill
diversity as "Mean Rarity", (2) visualizing and interpreting "Mean Rarity", and
(3) simulating species abundance distributions with known diversity. The package
is available online on Github (see Data accessibility). An interactive shiny
application for building "balance plots" is also available online
(https://mean-rarity.shinyapps.io/rshiny_app1/).

# PACKAGE DESCRIPTION
## Computing Mean Rarity
`rarity()` computes Hill diversity of a sample, parameterized in terms of the
mean rarity.

We define Hill diversity $D$ as the mean species rarity in the assemblage

$$D=\left( \sum_{i=1}^{S}p_{i}(r_{i})^{\ell} \right)^{1/\ell} \tag{1}$$

where $D$ is diversity or mean rarity, $p_{i}$ is the relative abundance of
species $i$, $r_{i}$ is the rarity of species $i$ (defined as the reciprocal of
$p_{i}$), $S$ is the total species richness, and $\ell$ is the scaling exponent
that determines the type of mean computed [@Roswell2021]. 

Hill diversity is more commonly written as

$$D=\left( \sum_{i=1}^{S}p_{i}^{q} \right)^{1/1-q} \tag{2}$$
When $\ell = 0$ ($q = 1$), these equations are defined by their limit.

Equations 1 and 2 are equivalent when $\ell = 1-q$.
Re-parameterizing Hill diversity in terms of species rarity can provide
conceptual clarity. Equation 1 is a weighted mean rarity, where the weights
(relative abundances, $p_i$) are factored out explicitly. Simplifying (as in
Equation 2) hides the weighting by relative abundance, and leads to the claim
that the scaling exponent is the "weight." The concrete meaning of "weight" when
applied to $q$ in Equation 2 may be difficult to understand.

Because Equations 1 and 2 are algebraically equivalent, `rarity(x, l)` is
equivalent to `vegan::renyi(x, scale = 1-l, hill = T)` and the `qD` output from
`iNEXT::estimateD(x)` where `order = 1-l`.



```{r compute rarity}
# for a totally even distribution, Hill diversity is the same regardless of `l`

even_comm <- rep(2, 6)
rarity(even_comm, 1) # richness
rarity(even_comm, -1) # Hill-Simpson

all.equal(rarity(even_comm, 0), rarity(even_comm, 0.34), rarity(even_comm, 1))

# for uneven communities, Hill diversity depends on `l`

uneven_comm <- c(20, 8, 5, 4, 2, 1)

l_vals <- c(1, 0, -1, 0.34)


data.frame(l = l_vals
           , Hill = sapply(l_vals, function(l){
                    rarity(uneven_comm, l)})
)

```

## Interpreting Mean Rarity

One way of interpreting Hill diversities is that they express the diversity of
an assemblage in terms of an imaginary assemblage with that same diversity, but
in which all species are equally abundant [@Jost2006]. The parameter $\ell$,
along with the distribution of abundances, determines where the equivalency lies
(that is, what is the "effective number of species" for that assemblage). The
`MeanRarity` package is designed to clarify what the choice of $\ell$ reflects.
Before diving in there, we can explore how different values of $\ell$ lead to
different diversities for the same assemblage.

It may be perplexing to claim that a single assemblage, say, the uneven
assemblage `uneven_comm`, is simultaneously as diverse as an assemblage of six
(richness, `l = 1`), four (Hill-Shannon diversity, `l = 0`), or three
(Hill-Simpson diversity, `l = -1`) species. Furthermore, when `l = 1`, this
assemblage is as diverse (or as species-rich) as *any assemblage* with six
species. At the same time, when `l = -1`, it is about as diverse as an
assemblage with twice the number of species and tremendous unevenness, or half
the number of species and perfect evenness:

``` {r effective numbers}
uneven_12 <- c(531, 186, 101,  63, 41, 28, 19, 13, 9, 5, 3, 1)
even_3 <- c(20, 20, 20)

rarity(uneven_comm, -1) %>% round(2)
rarity(uneven_12, -1) %>% round(2)
rarity(even_3, -1) %>% round(2)

```

Many authors have described $\ell$ as a factor that weights species relative
abundances - presumably suggesting that downweighting rare species means a lower
effective diversity, upweighting them means a higher effective diversity.
Another interpretation (developed in this package) is that $\ell$ **rescales**
species *rarities*. This interpretation lends itself to concrete visualizations
of Hill diversities as mean rarities, provided by `rarity_plot()`.

`rarity_plot()` makes "balance plots," introduced below, to visualize mean
rarity. The idea behind a balance plot is that means measure the weighted
center, or a balance point, for a set of values. Of course, if you have a plank
with many weights on it, where the balance point lies depends not only on the
weights, but also on their relative locations... the farther towards the ends of
the plank a weight lies, the more leverage it has. When describing diversity,
there are simple rules for the species weights ([relative] abundances) and where
they lie (their *scaled* rarities). The rarity scaling is given by the exponent
$\ell$ from equation 1, the argument `l`. Here, we create three balance plots
for the three Pythagorean means, given when $\ell \in \{1, 0, -1\}$:
<!-- $\ell$ should show up now with html rendering but probably not .pdf-->

```{r Balance plot setup}

rich_bal <- rarity_plot(ab = uneven_comm, l = 1, base_size = 12) +
  ggplot2::labs(x = "") +
  ggplot2::labs(title = "\u2113 = 1\n richness") +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.6
                                                    , vjust = 0.5
                                                    # , family = "Arial Unicode MS"
                                                    )
                 ) + 
  ggplot2::scale_color_brewer(type = "qual", palette = "Dark2")

shan_bal <- white_y( # hide y axis
  rarity_plot(ab = uneven_comm
              , l = 0
              , base_size = 12
              , verbose = F)) +
    ggplot2::labs(title = "\u2113 = 0\nHill-Shannon diversity") +
    ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.6
                                                    , vjust = 0.5
                                                    # , family = "Arial Unicode MS"
                                                    )
                 ) + 
    ggplot2::scale_color_brewer(type = "qual", palette = "Dark2")

simp_bal <- white_y(
  rarity_plot(ab = uneven_comm
              , l = -1
              , base_size = 12
              , verbose = F)) +
  ggplot2::labs(title = "\u2113 = -1\nHill-Simpson diversity") +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.6
                                                    , vjust = 0.5
                                                    # , family = "Arial Unicode MS"
                                                    )
                 ) +
  ggplot2::labs(x = "") +
  ggplot2::scale_color_brewer(type = "qual", palette = "Dark2")
```

<!-- should say more. Call more attention to the points and how they move and
how diversity moves and all. Otherwise the coolness of this easy to miss. Also,
consider making the reference points bigger since they aren't that visually
distinct for some eyes.-->
In a balance plot, the species abundances are plotted on the y-axis, species
rarities on the x-axis (values are back-transformed, but scaling is dictated by
`l`), the mean is shown with a triangular "fulcrum," and reference points are
illustrated for the three Pythagorean means (i.e., arithmetic, geometric, and
harmonic, given when `l= c(1, 0, -1)`, and equal to richness, Hill-Shannon
diversity, and Hill-Simpson diversity). By default, each individual is plotted
as a "block", and species with the same rarity are stacked vertically.

```{r Balance plot print, out.width = '33%', out.height = '33%', fig.show = "hold"}
rich_bal
shan_bal
simp_bal

```

## Simulating communities with known diversity

Unfortunately, it is difficult to assess the performance of diversity estimators
with real-world data, because ecological communities are not typically fully
censused, and therefore the true diversity of those communities is not known.
`MeanRarity` includes a tool to simulate species abundance distributions where
diversity values are given as parameters. This way, diversity (in this case,
richness and Hill-Simpson diversity) are known and fixed, rather than
epiphenomena that fall out of the simulations. In order to achieve this, we
simulate species abundance distributions with known, finite, true diversity, but
infinite abundance, from which finite samples may be taken. The diversity of a
given sample from such as SAD is, of course, not precisely pre-determined.

This approach differs from species abundance distribution simulations
implemented in other R packages. For example, `mobsim` [@May2018a] and `sads`
(CITE) allow users to specify continuous parametric probability distributions,
but then take finite, discrete samples from those distributions in
the simulation (in `mobsim` these can even be spatially explicit!). Users input
canonical parameters of the probability distributions and the number of
individuals to sample. These are powerful simulation tools, but one drawback is
that the diversity resulting from any given set of parameter values is variable.

`fit_SAD()`, by contrast, does not simulate individuals at all. Instead, it
always gives precisely the same relative abundances for a given set of
parameters, which may be a helpful tool for exploring the behavior of diversity
metrics under different assemblage size and sampling scenarios.

`fit_SAD()` simulates a species abundance distribution with known richness,
Hill-Simpson diversity, and a distributional assumption (lognormal or gamma). It
returns a shape parameter for the chosen probability distribution (because we're
focused on relative abundances, multiplicative rescaling is irrelevant), the
richness, Hill-Shannon, and Hill-Simpson diversity of the simulated species
abundance distribution, and relative abundances for each simulated species. It
provides a warning when the distribution includes species with very low relative
abundances, which implies a large total assemblage abundance.

To visualize a realized or simulated species abundance distribution,
`MeanRarity` includes the convenience function `radplot()`, which plots species
[relative] abundances against species ranks. <!-- consider cutting this which is
a pretty rnadom detail--> The default behavior is *not* to log-transform
[relative] abundances (i.e. it does not, by default, generate a "Whitaker
plot").

```{r fit species abundance distributions}
# set target richness and Hill-Simpson diversity levels
rich <- 20
simpson <- 12
even_SAD <- fit_SAD(rich = rich, simpson = simpson, distr = "lnorm")

#output is a list with three elements
even_SAD

rich <- 20
simpson <- 6
uneven_SAD <- fit_SAD(rich = rich, simpson = simpson, distr = "lnorm")



ev<-radplot(even_SAD$rel_abundances) +
  ggplot2::labs(y = "relative abundance", title =NULL)+
  ggplot2::ylim(c(0, 0.4))
un<-radplot(uneven_SAD$rel_abundances) +
  ggplot2::labs(y = "relative abundance", title =NULL) +
  ggplot2::ylim(c(0, 0.4))
```
``` {r plot radplots, fig.width = 3, fig.height =3, fig.show = "hold"}
ev
un
```

`fit_SAD()` generates an ideal species abundance distribution, with relative
abundances for a assemblage with infinite abundance. To take a finite sample, we
use `sample_infinite()` (so named because it samples an infinite SAD;
`sample_finite()` is for sub-sampling from a realized assemblage/finite sample).
The realized samples have Poisson-type noise about the mean species relative
abundances given by `fit_SAD()` (that is, they are samples from a multinomial
distribution). The diversity of a sample asymptotically approaches the simulated
diversity as sample size approaches infinity.
<!-- the section above could be tightened. A key issue is that the paragraphs
above make it clear what `fit_SAD` does but not as much what it is for. A
central point is that one generates samples from the distribution given by
fit_SAD-->

```{r sample from SAD}

# diversity of a small sample unlikely to match the simulated diversity values

# first, sample from our simulated SADs

even_sample <- sample_infinite(even_SAD$rel_abundances, 50)
uneven_sample <- sample_infinite(uneven_SAD$rel_abundances, 50)
#sample_infinite returns a numeric vector of sample species abundances
even_sample
uneven_sample

# we can compare evenness (given a scaling parameter `l`)
# the evenness is the normalized ratio of an arbitrary Hill diversity to richness
e3Fun(even_sample, -1)
e3Fun(uneven_sample, -1)

# compare diversity from sample vs. ideal SAD:
# likely pretty far off for a small sample!

# with an even SAD, all diversities lower
even_SAD$community_info
rbind(lapply(c(1, 0, -1), function(l){
  rarity(even_sample, l)
}))

# with an uneven SAD, sample Hill-Simpson can be higher than true Hill-Simpson
# richness is always lower
uneven_SAD$community_info
rbind(lapply(c(1, 0, -1), function(l){
  rarity(uneven_sample, l)
}))


big_even_sample <- sample_infinite(even_SAD$rel_abundances, 1e7)
big_uneven_sample <- sample_infinite(uneven_SAD$rel_abundances, 1e7)

# with a big enough sample, simulated diversities nearly recovered
even_SAD$community_info
rbind(lapply(c(1, 0, -1), function(l){
  rarity(big_even_sample, l)
}))
```

For any distribution of relative abundances, one can ask, "what is the Hill
diversity of this distribution?" Yet the answer, of course, depends on the
chosen value of the scaling parameter $\ell$. For a comprehensive answer, one
might look across values of $\ell$, also known as a Hill "diversity profile"
[@Chao2014b]. `MeanRarity` provides a function to generate a Hill diversity
profile based on $\ell$ (rather than $q$): `divpro()`.
<!-- these should be on a single plot, will be much more interesting that way!-->

```{r diversity profile}
# the even and uneven communities have same richness but different Hill diversity when `ell != 1`
ggplot2::ggplot(divpro(even_SAD[[3]]),
                ggplot2::aes(ell, d)) +
  ggplot2::geom_line() +
  ggplot2::ylim(0,22) +
  ggplot2::theme_classic() +
  ggplot2::labs(x = "scaling exponent \'l\'", y = "Hill diversity")

ggplot2::ggplot(divpro(uneven_SAD[[3]]),
                ggplot2::aes(ell, d)) +
  ggplot2::geom_line() +
    ggplot2::ylim(0,22) +
  ggplot2::theme_classic() +
  ggplot2::labs(x = "scaling exponent \'l\'", y = "Hill diversity")



```

# EXAMPLE APPLICATIONS

## Drivers of sampling uncertainty in Hill diversity estimates

Accurate estimates of Hill diversity based on sample data are notoriously
challenging [@Roswell2021]. Although many estimators have been used, the two
most common approaches are to a) calculate the diversity of samples directly, or
b) use non-parametric estimators of the diversity of the entire assemblage. Both
approaches have merit for comparing communities and ecosystems [@Gooriah2021].
While the degree to which sample diversity and asymptotic estimates each differ
from the true diversity (bias) has received substantial study, the sampling
variation in each type of Hill diversity estimate is less understood.
`MeanRarity` provides a toolkit to explore accuracy and sampling uncertainty for
Hill diversity estimates. Because this package simulates species abundance
distributions with known diversity, it allows examination of the drivers of
sampling variation in Hill diversity estimates.

It is well-known that the diversity of a sample tends to be lower than the
diversity of the assemblage from which the sample was drawn. This "bias" is most
acute for species richness, but can be substantial for all Hill diversities. The
degree of mismatch between the sample and true diversity is difficult to know
with real assemblages, but this can be addressed directly through simulation. At
the same time, current asymptotic Hill diversity estimators [@Chao2015]
typically exhibit little bias when sample sizes are reasonably large (hundreds
of individuals) and $\ell < \sim 0.75 $. Less well-understood is how different
features of the species abundance distribution (e.g. evenness, or just how rare
the rarest species are) drive the degree of difference between either sampled
diversity or asymptotic estimators, and the true diversity of the sampled
species abundance distribution.

Similarly, the sampling variation in Hill diversity estimates (both sample
diversity and asymptotic estimators) is poorly understood. Intuitively, sampling
variability in Hill diversity estimates must depend jointly on sample size, the
species abundance distribution, and the scaling exponent for Hill diversity.
However, users of Hill diversity currently lack guidance on  the relationship
between their metric choice and the sampling variability they might expect.
Variability, along with bias, is an important consideration when selecting a
diversity metric. Especially when the number of replicates is modest, as is
often the case in ecological studies, inaccuracy due to random sampling
variability could lead to equally misleading results as could bias *CITE THIS*.

To explore how the shape of the species abundance distribution and sample size
drive the sampling expectations for sample and asymptotic Hill diversity
estimates, we can first simulate species abundance distributions using the
function `MeanRarity::fitSAD()`. Here, we generated 6 distributions: for three
levels of evenness, we simulated both a lognormally- and gamma-distributed
assemblage of 100 species. To parameterize evenness, we used (Hill-Simpson
diversity -1)/(richness-1), which is equal to 1 with a perfectly even
species-abundance distribution, and 0 when Hill-Simpson diversity reaches its
minimum, 1, for any richness value [@Kvalseth1991, @Chao2019a]. Thus, in each
simulated assemblage, we know richness to be 100, Hill-Simpson takes one of
three values given by the evenness parameters, and other Hill diversities depend
on the distributional assumption (gamma or lognormal).

`MeanRarity::fitSAD()` returns species relative abundances (a SAD), and we
generate finite, discrete abundance samples with the function
`MeanRarity::sample_infinite()`. Here, we generated 1000 samples from each
simulated SAD of 31, 100, 316, and 1000 individuals. Then, for each sample, we
computed Hill diversity profiles for both the sample and estimated asymptotic
Hill diversities. For each combination of SAD, sample size, and estimate type
(i.e., sample or asymptotic) we plotted the scaled mean absolute error of each
Hill diversity estimate (a unitless measure of bias) and the standard deviation
of the log Hill diversity (a unitless measure of variability) for the entire
Hill diversity profile from Hill-Simpson diversity to richness. We asked, on a
relative scale, how choice of scaling exponent for Hill diversity would affect
not only bias, but also sampling variability, and explored the interactions with
evenness, distributional assumption, and sample size.


```{r Hill-Simpson is wiggly, eval = F}
library(furrr)
library(MeanRarity)
plan(strategy = "multiprocess", workers = 7)
evenness<-10^seq(-0.75,-0.35,0.2)
rich <- 100
sample_sizes <- floor(10^seq(1.5, 3, 0.5))
# generate SADs with 100 spp and varying evenness, parametric distributions
SADS<-purrr::flatten(
  purrr::map(
    evenness, function(simp_evenness){
      purrr::map(
        c("lnorm", "gamma"), function(dist){
          fit_SAD(rich = rich
                  , simpson = simp_evenness*(rich-1)+1
                  , distr = dist)
        })
    }))

# set sample size
reps <- 1e3
sample_data<-purrr::map_dfr(SADS, function(mySAD){
  evenness = (mySAD[[2]][3]-1)/(mySAD[[2]][1]-1)
  distribution = mySAD[[1]][1]
    purrr::map_dfr(sample_sizes, function(SS){
      sample_abundances = replicate(reps, sample_infinite(ab = mySAD[[3]], size = SS))
      furrr::future_map_dfr(seq(-1.5, 1.5, 0.01), function(ell){
        true_diversity = rarity(ab = mySAD[[3]], l = ell)
        sample_diversity = sapply(1:reps, function(rep){rarity(ab = sample_abundances[, rep], l = ell)})
        estimated_diversity = sapply(1:reps, function(rep){Chao_Hill_abu(sample_abundances[, rep], l = ell)})
        return(data.frame(evenness
                          , distribution
                          , SS
                          , ell
                          , true_diversity
                          , sample_diversity
                          , estimated_diversity
                          , row.names = NULL))
    })
  })
})


plot_data<-sample_data %>%
  dplyr::group_by(evenness, distribution, ell, SS) %>%
  dplyr::summarize(sample = sd(ifelse(sample_diversity == 0, 0, log(sample_diversity)))
                   , asymptotic = sd(ifelse(estimated_diversity == 0, 0, log(estimated_diversity)))
                   , true_diversity = mean(true_diversity)
                   , mean_sample = mean(sample_diversity)
                   , mean_asymptotic = mean(estimated_diversity)) %>%
  dplyr::mutate(evenness = as.factor(round(evenness, 2))
                , sample_size = SS)


```

Our findings for bias were similar to those reported elsewhere *CITE*. We found
a strong negative bias for species richness for the asymptotic estimator, as
well as for the sample diversity. Evenness and distributional assumption of the
SAD affected the bias for both sample and Hill diversity estimates. More even
communities tended to exhibit lower bias for richness but higher bias for
Hill-Simpson diversity, although this pattern depended to some degree on both
distributional assumption and sampling intensity. For the asymptotic Hill
diversity estimates, bias at very low sample sizes was less than sample
diversity but could still be extreme. However, this bias evaporated quickly for
both sample and asymptotic Hill diversity estimates when the scaling exponent
$\ell << 1 $.


<-- Figures showing bias for sample diversity and Chao/Jost asymptotic estimators -->
```{r bias figure , fig.height = 7, fig.width = 7}

# so called "bias" in sample diversity... w.r.t. diveristy of full assemblage
plot_data %>%
  ggplot2::ggplot(ggplot2::aes(x = ell
                               , color = evenness
                               , shape = distribution)) +
  ggplot2::geom_line(ggplot2::aes(y = (mean_sample-true_diversity)/true_diversity, color = evenness, linetype = distribution), size = 0.8) +
  ggplot2::theme_classic() +
  ggplot2::xlim(c(-1,1)) +
  ggplot2::scale_color_brewer(palette = "Set2") +
  ggplot2::facet_wrap(~sample_size
                      , labeller = "label_both") +  #function(x){sapply(x, function(y){paste(y, " individuals")})}) +
  ggplot2::labs(x = "scaling exponent \U2113", y = "scaled average (sample - true diversity)") +
  ggplot2::scale_y_continuous(limits = c(-0.8, 0.8)) +
  ggplot2::geom_hline(yintercept = 0)


# bias for the asymptotic estimator
plot_data %>%
  ggplot2::ggplot(ggplot2::aes(x = ell
                               , color = evenness
                               , shape = distribution)) +
  ggplot2::geom_line(ggplot2::aes(y = (mean_asymptotic-true_diversity)/true_diversity, color = evenness, linetype = distribution), size = 0.8) +
  ggplot2::theme_classic() +
  ggplot2::xlim(c(-1,1)) +
  ggplot2::scale_color_brewer(palette = "Set2") +
  ggplot2::facet_wrap(~sample_size
                      , labeller = "label_both") +  #function(x){sapply(x, function(y){paste(y, " individuals")})}) +
  ggplot2::labs(x = "scaling exponent \U2113", y = "scaled average (asymptotic - true diversity)") +
  ggplot2::scale_y_continuous(limits = c(-0.8, 0.8)) +
  ggplot2::geom_hline(yintercept = 0)

```

Much less explored is the variability of both sample diversity, and of
asymptotic diversity estimates, under random sampling expectations. Here, our
results were striking, and challenged the orthodoxy that Hill-Simpson diversity
is the low-uncertainty option for comparing assemblages *CITE BEST REFS ON
THIS*. The sample Hill-Simpson diversity, which has been promoted as a diversity
metric that is robust to variation in sampling intensity [@Chase2013], exhibited
high sampling uncertainty for most SADs and sampling intensities... greater
variability than for any other Hill diversity. The asymptotic estimator was
typically more variable than the sample diversity was. This was especially the
case for richness. While the sampling variability in the asymptotic Hill-Simpson
diversity was still higher than for the asymptotic Hill-Shannon diversity, as we
saw for the sample diversity, as the scaling exponent $\ell$ approached zero
(i.e. increased emphasis on rare species, closer to richness), the variability
was high and declined slowly with additional sampling. Depending on the evenness
and distributional assumption of the SAD, the asymptotic richness estimate could
be more, or less, than the variability in the asymptotic Hill-Simpson diversity
estimate.

```{r sampling variation in diversity estimates, fig.height = 7, fig.width = 7}
# variability in sample diversity

plot_data %>%
  ggplot2::ggplot(ggplot2::aes(x = ell
                               , y = sample
                               , color = evenness
                               , shape = distribution)) +
  ggplot2::geom_line(ggplot2::aes(color = evenness, linetype = distribution), size = 0.8) +
  ggplot2::theme_classic() +
  ggplot2::xlim(c(-1,1)) +
  ggplot2::scale_color_brewer(palette = "Dark2") +
  ggplot2::facet_wrap(~sample_size, scales = "free_y"
                      , labeller = "label_both") + #function(x){sapply(x, function(y){paste(y, " individuals")})}) +
  ggplot2::labs(x = "scaling exponent \U2113", y = "scaled variability in sample diversity (sdlog)") +
  ggplot2::scale_y_continuous(limits = c(0, NA),
                     expand = ggplot2::expansion(mult = c(0, 0.1)))

# plot for variability in asymptotic diversity estimates
plot_data %>%
  ggplot2::ggplot(ggplot2::aes(x = ell
                               , y = asymptotic
                               , color = evenness
                               , shape = distribution)) +
  ggplot2::geom_line(ggplot2::aes(color = evenness, linetype = distribution), size = 0.8) +
  ggplot2::theme_classic() +
  ggplot2::xlim(c(-1,1)) +
  ggplot2::scale_color_brewer(palette = "Dark2") +
  ggplot2::facet_wrap(~sample_size, scales = "free_y"
                     , labeller = "label_both") +  #function(x){sapply(x, function(y){paste(y, " individuals")})}) +
  ggplot2::labs(x = "scaling exponent \U2113", y = "scaled variability in asymptotic diversity estimate (sdlog)") +
  ggplot2::scale_y_continuous(limits = c(0, NA),
                              expand = ggplot2::expansion(mult = c(0, 0.1)))




```

# ALTERNATIVE SOFTWARE
Functions to generate similar diversity estimates and assemblage simulations are
available in several R packages.

<!-- this is currently placeholders, but need to fill this out. Will require some serious focused time and maybe some blog posts -->

1. `iNEXT`
  The R package `iNEXT` provides tools for rarefaction and extrapolation of
  sample Hill diversity estimates, and point estimates for asymptotic estimators
  for richness, Hill-Shannon, and Hill-Sampson. It computes sample Hill
  diversity for $\ell\leq 1 = q \geq 0$. The function `MeanRarity::rarity()`
  also computes mean rarity when $\ell>1$. Although estimates from `iNEXT` and
  `MeanRarity` should tend to be congruent for $\ell = 1-q$, MeanRarity provides
  users with the option to use $\ell$ throughout, emphasizing the MeanRarity
  framework developed in Roswell et al. 2021 [@Roswell2021]. `iNEXT` functions
  are highly integrated, generating multiple outputs and computing bootstrapped
  variance estimates by default, whereas in `MeanRarity` most exported functions
  are comparatively simple. `MeanRarity` enables parameterizing Hill diversity
  with `q` or `l`, and provides tools for simulating species abundance
  distributions and visualizing mean rarity, which `iNEXT` does not, this may
  make `MeanRarity` best suited to students and those studying biodiversity
  estimation. `iNEXT` is well-suited to plotting empirical diversity data from a
  small to modest number of assemblages.
1. `SpadeR`
  The R package `SpadeR` provides similar estimates for Hill diversity as iNEXT,
  also parameterized by $q$ rather than $\ell$ (`MeanRarity` allows either
  parameterization, defaulting to $\ell$). `SpadeR::diversity`, like
  `MeanRarity::divpro`, generates a Hill diversity "profile". Internal functions
  from `SpadeR` are used as source code in `MeanRarity` (e.g. a simplified
  version of`SpadeR:::Chao_Hill_abu()` is an exported function in `MeanRarity`).
  While `SpadeR` provides a suite of tools for estimating alpha- and
  beta-diversity, `MeanRarity` provides additional tools for simulation,
  visualization, and alternative parameterization.
1. `vegan`
  The R package `vegan` contains a multitude of tools for comparing community
  data in R. Like `MeanRarity`, `vegan` contains tools to estimate Hill
  diversity (`vegan::renyi(..., hill = TRUE)`), rarefy
  datasets`vegan::specaccum()`, and fit parametric distributions to abundance
  vectors `vegan::fisherfit()`. While `vegan` is highly versatile, historical
  artifacts may lead to confusion about Hill diversity. For example,
  `vegan::diversity(x, "invsimpson") = 1/(1-vegan::diversity(x, "simpson"))`,
  although users might assume that 
  `vegan::diversity(x, "invsimpson") = 1/vegan::diversity(x, "simpson")`.
  `MeanRarity` focuses on the interpretation of Hill diversities as average of
  species rarities across scales to dispel confusion.
1. `sads`
  The R package `sads` provides functions to fit parametric distributions to
  abundance vectors using maximum-likelihood. The function ``sads::rsad()`, like
  `MeanRarity::fit_SAD()`, generates abundance vectors based on parametric
  distributions for true species abundance distributions. While `sads::rsad()`
  returns integer-abundance for a simulated *sample* from a parametric species
  abundance distribution, `MeanRarity::fit_SAD()` returns relative abundances
  for the underlying distribution itself. `MeanRarity::fit_SAD` expands on the
  functionality of `sads::rsad` by enabling users to parameterize the underlying
  species abundance distributions by both true richness and true Hill-Simpson
  diversity, rather than richness alone.
1. `mobsim`
  The R package `mobsim` expands on the simulations provided by `sads` to
  generate spatially-explicit simulations. Unlike `MeanRarity`, `mobsim`
  provides tools to simulate and estimate diversity-area relationships. However,
  in `mobsim` the diversity of an assemblage is an outcome of a simulation,
  rather than an input, whereas `MeanRarity::fit_SAD` allows users to input
  diversity directly. These functionalities enable complementary approaches to
  studying the behavior of diversity estimates under different sampling
  scenarios.
1. `entropart`
1. `EntropyEstimation`

# CONCLUSIONS

<!-- this is repetitive, needs to be tightened --> 
The combination of tools for simulation, estimation, and visualization of
biodiversity provided by `MeanRarity` enables a coherent study of Hill diversity
metrics through the framework of average species rarity. The package supports
interpretation of popular diversity metrics and exploration of numerical and
statistical properties of these metrics and their estimators. We tested how
different distributions of relative abundance in assemblages drives sampling
uncertainty in Hill diversity estimators. We found that Hill-Simpson diversity
and its asymptotic estimator, which have been promoted as stable, robust
measures of biodiversity due to relative emphasis on common, rather than rare
species, exhibit high variability, especially in the presence of low evenness
and very rare species. The `MeanRarity` package facilitates simulating
assemblages with known diversity, which is not easily done with other popular
software packages for biodiversity science. As Hill diversity metrics gain
popularity, `MeanRarity` provides tools to estimate and visualize them in a
coherent framework absent from other statistical packages, and enables
continuing research into the properties of these metrics.

## Acknowledgements
We thank Luke Harmon for early feedback on the R package, Dan Gruner for his
thoughtful comments on this manuscript, and....

## Author contributions

M.R. and J.D. conceived the package concept and structure and generated source
code for package functions. M.R. implemented the first package version and the
shiny online application. M.R. wrote the manuscript with help from J.D.

# DATA ACCESSIBILITY
This article does not use any empirical data. The package is available on Github
(SOME KIND OF URL OR DOI REF).

<!-- looks like this was an attempt to hard-code a table of functions, but the dynamically-generated one from pkgdown or a modification thereof seems better-->


```{r table of functions}
table_dat<-data.frame(
  `Function name` = c("rarity", "rarity_plot", "radplot", "divpro", "sample_infinite", "sample_finite", "fit_SAD")
  , `General purpose` = c("Computation", "Visualization", "Visualization", "Visualization", "Sampling", "Sampling", "Simulation")
  , `Description` = c("Compute Hill diversity using the rarity parameterization")
)
```








